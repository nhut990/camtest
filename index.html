<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kiểm tra Camera & Micro - Test trực tiếp trên Web</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;line-height:1.4;padding:18px;background:#f7f7f9;color:#111;}
  h1{font-size:1.2rem;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  select,button{padding:8px;border-radius:6px;border:1px solid #cfcfcf;}
  button,
  .fullscreen-btn {
    background: #ff9800;
    color: #fff;
    border: 1.5px solid #e65100;
    font-weight: 600;
    transition: background 0.15s, box-shadow 0.2s;
  }
  button:hover,
  .fullscreen-btn:hover {
    background: #ffa726;
    box-shadow: 0 0 0 2px #e65100;
    color: #fff;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f5f5f5 !important;
    color: #aaa !important;
    border-color: #eee !important;
  }
  video{width:100%;max-width:560px;border-radius:8px;background:#000;display:block}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .meter{width:200px;height:24px;border-radius:6px;background:#eee;overflow:hidden;position:relative}
  .meter>.level{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#ffeb3b)}
  .panel{margin-top:12px;max-width:760px}
  .small{font-size:0.9rem;color:#444}
  .note{font-size:0.85rem;color:#444;margin-top:8px}
  audio{display:block;margin-top:8px}
  .timer{padding:6px 8px;border-radius:6px;background:#fff;border:1px solid #ddd}
  .note b{color:#000}
  hr {
    margin: 18px 0;
    border: none;
    border-top: 5px solid #ff9800;
    border-radius: 2px;
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.10);
  }
  .footer{margin-top:40px;text-align:center;color:#555;font-size:0.95rem;}
  .footer a{color:#1976d2;text-decoration:none;font-weight:500;}
  .credit{margin-top:4px;font-size:0.92rem;color:#888;}
  .disabled-link {
    pointer-events: none;
    opacity: 0.5;
    cursor: not-allowed;
    color: #999 !important;
    border-color: #eee !important;
    background: #f9f9f9 !important;
    text-decoration: none !important;
  }
  #photoBlock {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  #photoCanvas, #photoImg {
    max-width: 240px;
    max-height: 180px;
    border-radius: 8px;
    border: 1.5px solid #ffa726;
    background: #fff;
  }
  #photoImg {
    cursor: pointer;
    transition: box-shadow 0.2s;
  }
  #photoImg:hover {
    box-shadow: 0 0 0 3px #ff9800;
  }
  .fullscreen-btn {
    margin-left: 6px;
    display: flex;
    align-items: center;
    z-index: 20;
  }
  .fullscreen-icon {
    width: 24px;
    height: 24px;
    display: block;
  }
  .video-container {
    position: relative;
    max-width: 560px;
    width: 100%;
  }
  .fullscreen-btn {
    position: absolute;
    right: 10px;
    bottom: 10px;
    z-index: 20;
  }
  .video-container.fullscreen {
    max-width: none;
    width: 100vw;
    height: 100vh;
    background: #222;
  }
  .video-container.fullscreen video {
    max-width: none;
    width: 100vw;
    height: 100vh;
    object-fit: contain;
    border-radius: 0;
  }
  .meter, .meter .level {
    opacity: 1 !important;
  }
</style>
</head>
<body>
  <h1>Trang kiểm tra Camera & Micro (Web)</h1>
  <div class="panel">
    <div class="row">
      <label>
        Camera:
        <select id="cameraSelect"></select>
      </label>
      <label>
        Micro:
        <select id="micSelect"></select>
      </label>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="startPreviewBtn">Bắt đầu Preview</button>
        <button id="stopPreviewBtn" disabled>Ngưng Preview</button>
        <button id="captureBtn" disabled>Chụp ảnh</button>
      </div>
    </div>
    <div class="video-container" id="videoContainer">
      <video id="videoPreview" playsinline autoplay muted></video>
      <button class="fullscreen-btn" id="fullscreenBtn" title="Toàn màn hình video">
        <svg class="fullscreen-icon" viewBox="0 0 50 50">
          <polyline points="17,6 6,6 6,17" style="fill:none;stroke:#e65100;stroke-width:5"/>
          <polyline points="33,6 44,6 44,17" style="fill:none;stroke:#e65100;stroke-width:5"/>
          <polyline points="17,44 6,44 6,33" style="fill:none;stroke:#e65100;stroke-width:5"/>
          <polyline points="33,44 44,44 44,33" style="fill:none;stroke:#e65100;stroke-width:5"/>
        </svg>
      </button>
    </div>
    <div id="photoBlock">
      <canvas id="photoCanvas" style="display:none"></canvas>
      <img id="photoImg" style="display:none" title="Bấm để xem ảnh kích thước lớn ở tab mới"/>
      <a id="downloadPhotoBtn" style="display:none;padding:8px;border-radius:6px;text-decoration:none;border:1.5px solid #ffa726;background:#fff;color:#111" download="photo.png">Tải ảnh về</a>
    </div>
    <div class="note">
      ⚠️ <b>Lưu ý:</b> Trình duyệt có thể yêu cầu quyền truy cập <b>camera</b> và <b>micro</b>. 
      Tính năng này chỉ hoạt động khi bạn <b>chọn Cho phép</b>.
    </div>
    <div class="row" style="align-items:center;margin-top:12px">
      <div class="small">Mức âm thanh (camera/micro):</div>
      <div class="meter" title="Audio level (camera)"><div class="level" id="meterLevel"></div></div>
      <div class="timer" id="levelDb">— dB</div>
    </div>
    <hr />
    <div class="row" style="align-items:center">
      <div class="small">Mức âm thanh khi ghi âm:</div>
      <div class="meter" title="Audio level (record)"><div class="level" id="recMeterLevel"></div></div>
      <div class="timer" id="recLevelDb">— dB</div>
    </div>
    <div style="margin-top:12px" class="controls">
      <button id="startRecBtn">Bắt đầu Ghi âm</button>
      <button id="stopRecBtn" disabled>Ngưng Ghi</button>
      <button id="playRecBtn" disabled>Phát Lại</button>
      <a id="downloadLink" 
        class="disabled-link"
        aria-disabled="true"
        tabindex="-1"
        style="display:inline-block;padding:8px;border-radius:6px;text-decoration:none;border:1.5px solid #ffa726;background:#fff;color:#111"
        download="recording.webm"
        href="javascript:void(0)"
      >Tải về</a>
      <div id="recTimer" class="timer">00:00</div>
    </div>
    <audio id="playback" controls></audio>
    <div class="note">Kết quả ghi âm có thể phát lại và tải về với định dạng .webm</div>
  </div>
  <div class="footer">
    <a href="https://nhut990.github.io/">Trang chủ</a>
    <div class="credit">
      Created by Minh Nhut<br>
      © 2025
    </div>
  </div>
<script>
(async function(){
  const cameraSelect=document.getElementById('cameraSelect');
  const micSelect=document.getElementById('micSelect');
  const startPreviewBtn=document.getElementById('startPreviewBtn');
  const stopPreviewBtn=document.getElementById('stopPreviewBtn');
  const videoPreview=document.getElementById('videoPreview');
  const meterLevel=document.getElementById('meterLevel');
  const levelDb=document.getElementById('levelDb');
  const recMeterLevel=document.getElementById('recMeterLevel');
  const recLevelDb=document.getElementById('recLevelDb');
  const startRecBtn=document.getElementById('startRecBtn');
  const stopRecBtn=document.getElementById('stopRecBtn');
  const playRecBtn=document.getElementById('playRecBtn');
  const downloadLink=document.getElementById('downloadLink');
  const playback=document.getElementById('playback');
  const recTimer=document.getElementById('recTimer');
  // Photo capture elements
  const captureBtn=document.getElementById('captureBtn');
  const photoCanvas=document.getElementById('photoCanvas');
  const photoImg=document.getElementById('photoImg');
  const downloadPhotoBtn=document.getElementById('downloadPhotoBtn');
  // Fullscreen elements
  const fullscreenBtn=document.getElementById('fullscreenBtn');
  const videoContainer=document.getElementById('videoContainer');

  let currentStream=null;
  let audioContext=null;
  let analyser=null;
  let rafId=null;
  let mediaRecorder=null;
  let recordedChunks=[];
  let recordingStart=null;
  let recTimerInterval=null;
  let recAnalyser=null;
  let recAudioCtx=null;
  let recRafId=null;
  let lastPhotoUrl=null;
  let isFullscreen=false;

  function setDownloadLinkDisabled(state) {
    if(state){
      downloadLink.classList.add('disabled-link');
      downloadLink.setAttribute('aria-disabled', 'true');
      downloadLink.setAttribute('tabindex', '-1');
      downloadLink.href = "javascript:void(0)";
    }else{
      downloadLink.classList.remove('disabled-link');
      downloadLink.setAttribute('aria-disabled', 'false');
      downloadLink.setAttribute('tabindex', '0');
    }
  }

  async function updateDeviceList(){
    try{
      const devices=await navigator.mediaDevices.enumerateDevices();
      const cams=devices.filter(d=>d.kind==='videoinput');
      const mics=devices.filter(d=>d.kind==='audioinput');
      const prevCam=cameraSelect.value;
      const prevMic=micSelect.value;
      cameraSelect.innerHTML=cams.map(c=>`<option value="${c.deviceId}">${c.label||'Camera '+(cams.indexOf(c)+1)}</option>`).join('') || '<option value="">(Không có camera)</option>';
      micSelect.innerHTML=mics.map(m=>`<option value="${m.deviceId}">${m.label||'Micro '+(mics.indexOf(m)+1)}</option>`).join('') || '<option value="">(Không có micro)</option>';
      if(cams.some(c=>c.deviceId===prevCam)) cameraSelect.value=prevCam;
      if(mics.some(m=>m.deviceId===prevMic)) micSelect.value=prevMic;
    }catch(err){
      console.warn('Không thể liệt kê thiết bị:',err);
    }
  }

  async function startPreview(){
    stopPreview();
    const constraints={
      audio: micSelect.value?{deviceId:{exact:micSelect.value}}:true,
      video: cameraSelect.value
        ? {deviceId:{exact:cameraSelect.value}, width:{ideal:1920, max:1920}, height:{ideal:1080, max:1080}}
        : {facingMode:'user', width:{ideal:1920, max:1920}, height:{ideal:1080, max:1080}}
    };
    try{
      currentStream=await navigator.mediaDevices.getUserMedia(constraints);
      const activeVideoTrack=currentStream.getVideoTracks()[0];
      if(activeVideoTrack && activeVideoTrack.getSettings){
        const usedDeviceId=activeVideoTrack.getSettings().deviceId;
        if(usedDeviceId) cameraSelect.value=usedDeviceId;
      }
      if(currentStream.getVideoTracks().length){
        videoPreview.srcObject=currentStream;
        videoPreview.muted=true;
        await videoPreview.play().catch(()=>{});
        stopPreviewBtn.disabled=false;
        startPreviewBtn.disabled=true;
        updateCaptureBtnState();
        setTimeout(()=>{
          // Log độ phân giải thực tế
          console.log('Video thực tế:', videoPreview.videoWidth+"x"+videoPreview.videoHeight);
        },500);
      }else videoPreview.srcObject=null;
      setupAudioMeter(currentStream);
      await updateDeviceList();
    }catch(err){
      alert('Lỗi khi truy cập camera/micro: '+(err.message||err.name));
      stopPreview();
    }
  }

  function stopPreview(){
    if(currentStream){
      currentStream.getTracks().forEach(t=>t.stop());
      currentStream=null;
    }
    if(videoPreview){videoPreview.pause();videoPreview.srcObject=null;}
    disconnectAudioMeter();
    stopPreviewBtn.disabled=true;
    startPreviewBtn.disabled=false;
    updateCaptureBtnState();
    hidePhoto();
  }

  function setupAudioMeter(stream){
    disconnectAudioMeter();
    if(!stream)return;
    const audioTracks=stream.getAudioTracks();
    if(!audioTracks.length)return;
    audioContext=new (window.AudioContext||window.webkitAudioContext)();
    const source=audioContext.createMediaStreamSource(new MediaStream(audioTracks));
    analyser=audioContext.createAnalyser();
    analyser.fftSize=2048;
    source.connect(analyser);
    const data=new Uint8Array(analyser.fftSize);
    function update(){
      analyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){const v=(data[i]-128)/128;sum+=v*v;}
      const rms=Math.sqrt(sum/data.length);
      const db=20*Math.log10(rms||1e-8);
      const pct=Math.min(100,Math.max(0,(rms*300)));
      meterLevel.style.width=pct+'%';
      levelDb.textContent=(db<=-160?'— dB':db.toFixed(1)+' dB');
      rafId=requestAnimationFrame(update);
    }
    update();
  }

  function disconnectAudioMeter(){
    if(rafId){cancelAnimationFrame(rafId);rafId=null;}
    if(analyser){analyser.disconnect();analyser=null;}
    if(audioContext){try{audioContext.close();}catch(e){}audioContext=null;}
    meterLevel.style.width='0%';
    levelDb.textContent='— dB';
  }

  function setupRecMeter(stream){
    stopRecMeter();
    if(!stream)return;
    recAudioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const source=recAudioCtx.createMediaStreamSource(stream);
    recAnalyser=recAudioCtx.createAnalyser();
    recAnalyser.fftSize=2048;
    source.connect(recAnalyser);
    const data=new Uint8Array(recAnalyser.fftSize);
    function update(){
      recAnalyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){const v=(data[i]-128)/128;sum+=v*v;}
      const rms=Math.sqrt(sum/data.length);
      const db=20*Math.log10(rms||1e-8);
      const pct=Math.min(100,Math.max(0,(rms*300)));
      recMeterLevel.style.width=pct+'%';
      recLevelDb.textContent=(db<=-160?'— dB':db.toFixed(1)+' dB');
      recRafId=requestAnimationFrame(update);
    }
    update();
  }

  function stopRecMeter(){
    if(recRafId){cancelAnimationFrame(recRafId);recRafId=null;}
    if(recAnalyser){recAnalyser.disconnect();recAnalyser=null;}
    if(recAudioCtx){try{recAudioCtx.close();}catch(e){}recAudioCtx=null;}
    recMeterLevel.style.width='0%';
    recLevelDb.textContent='— dB';
  }

  function startRecording(){
    stopRecording();
    setDownloadLinkDisabled(true);
    const constraints={audio: micSelect.value?{deviceId:{exact:micSelect.value}}:true};
    navigator.mediaDevices.getUserMedia(constraints).then(stream=>{
      recordedChunks=[];
      const options={};
      if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus'))options.mimeType='audio/webm;codecs=opus';
      else if(MediaRecorder.isTypeSupported('audio/ogg;codecs=opus'))options.mimeType='audio/ogg;codecs=opus';
      mediaRecorder=new MediaRecorder(stream,options);
      mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size)recordedChunks.push(e.data);};
      mediaRecorder.onstop=()=>{
        const blob=new Blob(recordedChunks,{type:recordedChunks[0]?.type||'audio/webm'});
        const url=URL.createObjectURL(blob);
        playback.src=url;
        playRecBtn.disabled=false;
        downloadLink.href=url;
        downloadLink.download='recording.'+(blob.type.includes('ogg')?'ogg':'webm');
        setDownloadLinkDisabled(false);
        stream.getTracks().forEach(t=>t.stop());
        stopRecMeter();
      };
      setupRecMeter(stream);
      mediaRecorder.start();
      recordingStart=Date.now();
      startRecBtn.disabled=true;
      stopRecBtn.disabled=false;
      playRecBtn.disabled=true;
      recTimer.textContent='00:00';
      recTimerInterval=setInterval(()=>{
        const s=Math.floor((Date.now()-recordingStart)/1000);
        const mm=String(Math.floor(s/60)).padStart(2,'0');
        const ss=String(s%60).padStart(2,'0');
        recTimer.textContent=`${mm}:${ss}`;
      },250);
    }).catch(err=>{
      alert('Không thể truy cập micro để ghi âm: '+(err.message||err.name));
      stopRecMeter();
      stopRecBtn.disabled=true;
      startRecBtn.disabled=false;
      setDownloadLinkDisabled(true);
    });
  }

  function stopRecording(){
    if(mediaRecorder && mediaRecorder.state!=='inactive'){
      mediaRecorder.stop();
    }
    if(recTimerInterval){clearInterval(recTimerInterval);recTimerInterval=null;}
    stopRecBtn.disabled=true;
    startRecBtn.disabled=false;
    stopRecMeter();
    setDownloadLinkDisabled(true);
  }

  playRecBtn.addEventListener('click',()=>{if(playback.src)playback.play().catch(()=>{});});
  startPreviewBtn.addEventListener('click',startPreview);
  stopPreviewBtn.addEventListener('click',stopPreview);
  startRecBtn.addEventListener('click',startRecording);
  stopRecBtn.addEventListener('click',stopRecording);

  cameraSelect.addEventListener('change',()=>{
    hidePhoto();
    if(currentStream)startPreview();
  });
  micSelect.addEventListener('change',()=>{
    if(currentStream)startPreview();
    if(mediaRecorder && mediaRecorder.state==='recording'){stopRecording();startRecording();}
  });

  navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener('devicechange',updateDeviceList);
  await updateDeviceList();

  setDownloadLinkDisabled(true);

  window.addEventListener('beforeunload',()=>{
    stopPreview();
    stopRecording();
    setDownloadLinkDisabled(true);
    if(lastPhotoUrl) URL.revokeObjectURL(lastPhotoUrl);
  });

  function updateCaptureBtnState() {
    captureBtn.disabled = !(currentStream && videoPreview.srcObject);
  }

  function hidePhoto() {
    photoCanvas.style.display = "none";
    photoImg.style.display = "none";
    downloadPhotoBtn.style.display = "none";
    if(lastPhotoUrl) {
      URL.revokeObjectURL(lastPhotoUrl);
      lastPhotoUrl = null;
    }
    photoImg.src = "";
  }

  function getCurrentDatetimeString() {
    const now = new Date();
    const pad = n => String(n).padStart(2,"0");
    const h = pad(now.getHours());
    const m = pad(now.getMinutes());
    const d = pad(now.getDate());
    const mo = pad(now.getMonth()+1);
    const y = now.getFullYear();
    return `${h}:${m} ${d}-${mo}-${y}`;
  }

  captureBtn.addEventListener('click', function(){
    if(!videoPreview.srcObject) return;
    const video = videoPreview;
    // Độ phân giải thực lưu đúng stream camera:
    const w = video.videoWidth;
    const h = video.videoHeight;
    photoCanvas.width = w;
    photoCanvas.height = h;
    const ctx = photoCanvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    const text1 = "Created by Minh Nhut";
    const text2 = getCurrentDatetimeString();
    ctx.save();
    ctx.font = "bold 36px 'Segoe UI', Arial, Helvetica, sans-serif";
    ctx.textBaseline = "bottom";
    ctx.textAlign = "right";
    const colorStroke = "#e65100";
    const colorFill = "#fff";
    const metrics1 = ctx.measureText(text1);
    const metrics2 = ctx.measureText(text2);
    const padding = 20;
    const lineGap = 12;
    const textHeight = 44;
    const totalHeight = textHeight*2 + lineGap + 16;
    const bgWidth = Math.max(metrics1.width, metrics2.width) + padding*2;
    const bgX = w - bgWidth - 16;
    const bgY = h - totalHeight - 16;
    const bgHeight = totalHeight;
    ctx.globalAlpha = 0.50;
    ctx.fillStyle = "#e65100";
    roundRect(ctx, bgX, bgY, bgWidth, bgHeight, 20);
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.lineWidth = 6;
    ctx.strokeStyle = colorStroke;
    ctx.fillStyle = colorFill;
    ctx.strokeText(text1, w - padding -16, h - totalHeight/2 - lineGap/2);
    ctx.fillText(text1, w - padding -16, h - totalHeight/2 - lineGap/2);
    ctx.strokeText(text2, w - padding -16, h - 24);
    ctx.fillText(text2, w - padding -16, h - 24);
    ctx.restore();

    photoCanvas.toBlob(function(blob){
      if(lastPhotoUrl) URL.revokeObjectURL(lastPhotoUrl);
      const url = URL.createObjectURL(blob);
      lastPhotoUrl = url;
      photoImg.src = url;
      photoImg.style.display = "block";
      photoCanvas.style.display = "none";
      downloadPhotoBtn.href = url;
      downloadPhotoBtn.style.display = "inline-block";
      // Log độ phân giải ảnh đã lưu:
      console.log('Ảnh lưu:', w+'x'+h);
    }, "image/png");
  });

  function roundRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.lineTo(x+w-r, y);
    ctx.quadraticCurveTo(x+w, y, x+w, y+r);
    ctx.lineTo(x+w, y+h-r);
    ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
    ctx.lineTo(x+r, y+h);
    ctx.quadraticCurveTo(x, y+h, x, y+h-r);
    ctx.lineTo(x, y+r);
    ctx.quadraticCurveTo(x, y, x+r, y);
    ctx.closePath();
  }

  stopPreviewBtn.addEventListener('click', function(){
    hidePhoto();
  });
  startPreviewBtn.addEventListener('click', function(){
    hidePhoto();
  });
  cameraSelect.addEventListener('change', function(){
    hidePhoto();
  });
  videoPreview.addEventListener('loadeddata', updateCaptureBtnState);
  videoPreview.addEventListener('emptied', updateCaptureBtnState);
  photoImg.addEventListener('click', function(){
    if(photoImg.src) {
      window.open(photoImg.src, '_blank');
    }
  });

  updateCaptureBtnState();

  // ================== FULLSCREEN ==================
  function enterFullscreen() {
    const el = videoContainer;
    if (el.requestFullscreen) {
      el.requestFullscreen();
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    } else if (el.msRequestFullscreen) {
      el.msRequestFullscreen();
    }
  }
  function exitFullscreen() {
    if(document.exitFullscreen){
      document.exitFullscreen();
    }else if(document.webkitExitFullscreen){
      document.webkitExitFullscreen();
    }else if(document.msExitFullscreen){
      document.msExitFullscreen();
    }
  }
  fullscreenBtn.addEventListener('click', function(e){
    if(isFullscreen){
      exitFullscreen();
    }else{
      enterFullscreen();
    }
  });
  function onFullscreenChange() {
    const isFull = document.fullscreenElement === videoContainer ||
                   document.webkitFullscreenElement === videoContainer ||
                   document.msFullscreenElement === videoContainer;
    isFullscreen = isFull;
    if (isFull) {
      videoContainer.classList.add('fullscreen');
      fullscreenBtn.title = "Thoát toàn màn hình";
      fullscreenBtn.style.background = "#ffa726";
    } else {
      videoContainer.classList.remove('fullscreen');
      fullscreenBtn.title = "Toàn màn hình video";
      fullscreenBtn.style.background = "#ff9800";
    }
  }
  document.addEventListener('fullscreenchange', onFullscreenChange);
  document.addEventListener('webkitfullscreenchange', onFullscreenChange);
  document.addEventListener('msfullscreenchange', onFullscreenChange);

})();
</script>
</body>
</html>
